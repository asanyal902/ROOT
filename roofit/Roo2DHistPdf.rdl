/*****************************************************************************
 * Project: BaBar detector at the SLAC PEP-II B-factory
 * Package: RooFitTools
 *    File: $Id: Roo2DHistPdf.rdl,v 1.1.2.3 2002/04/30 17:47:43 zhanglei Exp $
 * Authors:
 *   AB, Adrian Bevan, Liverpool University, bevan@slac.stanford.edu
 *
 * History:
 *   08-Aug-2001 AB Created Roo2DHistPdf
 *   25-Aug-2001 AB Ported to RooFitCore/RooFitModels
 *   17-Apr-2002 LZ event generator for Roo2DHistPdf zhanglei@slac.stanford.edu
 *
 * Copyright (C) 2001, Liverpool University
 *****************************************************************************/
#ifndef ROO_2DHIST
#define ROO_2DHIST

#include "RooFitCore/RooAbsPdf.hh"
#include "RooFitCore/RooRealProxy.hh"
#include "TH2.h"
#include "TFile.h"
#include "RooFitCore/RooRandom.hh"

class RooRealVar;
class RooDataSet;

class Roo2DHistPdf : public RooAbsPdf {
public:
  Roo2DHistPdf(const char * name, const char *title,
             RooAbsReal& x, RooAbsReal &y, const char * rootFile, const char * histName, TString options);
  Roo2DHistPdf(const char * name, const char *title,
             RooAbsRealLValue& x, RooAbsRealLValue &y, RooDataSet & data, TString options);
  Roo2DHistPdf(const char *name, const char *title,
             RooAbsReal& x, RooAbsReal &y, TH2F * hist, TString options);
  Roo2DHistPdf(const char *name, const char *title,
             RooAbsReal& x, RooAbsReal &y, TH2D * hist, TString options);

  Roo2DHistPdf(const Roo2DHistPdf& other, const char* name=0);
  virtual TObject* clone(const char* newname) const { return new Roo2DHistPdf(*this,newname); }

  virtual ~Roo2DHistPdf();

// interesting values for 'options':
// 'e' extrapolate between bins when using evaluate(), if this option is not set, the actual
//     bin content is used instead
// 's' set to smooth the probability LUT - not yet implemented :-(
  Int_t loadNewHist(TH2F * aNewHist, TString options);

  RooRealProxy x;
  RooRealProxy y;

  // generator of our own
  virtual Bool_t isDirectGenSafe(const RooAbsArg& arg) const;
  virtual Int_t getGenerator(const RooArgSet& directVars,RooArgSet &generateVars)const;
  virtual void generateEvent(Int_t code);
  
protected:
  Int_t    GetProbability(TH2F * theHist);      //calculate PDF LUT, _p[];
  Double_t evaluate() const;
  void     SetOptions(TString options = "");

private:
  TFile    * _file;
  TH2F     * _hist;

  Double_t _xbinWidth;
  Double_t _ybinWidth;
  Double_t _lox,_hix;
  Double_t _loy,_hiy;

  Int_t    _iWantToExtrapolate, _iWantToSmooth;
  Int_t    _nPointsx;
  Int_t    _nPointsy;
  enum   { _nPoints = 200 };           //granularity of LUT - use a linear extrapolation between points
                                     //to improve upon the resolution

  Double_t _p[_nPoints][_nPoints];   //probability of the PDF in (x,y) plane [granularity fixed by _nPoints]
  Double_t _MaxP;

  ClassDef(Roo2DHistPdf,0) //2D Hist PDF builder
};

#endif

